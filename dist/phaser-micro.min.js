/* Phaser-Micro v1.0.0 (C) Copyright 2015 Photon Storm Ltd. */
(function(){var a=this,b=b||{};return b.showLog=!0,b.log=function(a,c,d){if(b.showLog){a="%c"+a;var e="color: "+c+"; background: "+d;console.log.apply(console,[a,e])}},b.Game=function(a,c,d,e,f){b.log("/// PhaserMicro v1.0 ///","#91c6fa","#0054a6"),this.parent=e||"",this.width=a||800,this.height=c||600,this.isBooted=!1,this.gl=null,this.canvas=null,this.context=null,this.state=f,this.cache=null,this.load=null,this.children=[],this.worldAlpha=1,this.worldTransform=new b.Matrix,this.frameCount=0,this.contextOptions={alpha:!1,antialias:!0,premultipliedAlpha:!1,stencil:!1,preserveDrawingBuffer:!1},this.projection={x:0,y:0},this.offset={x:0,y:0},this.drawCount=0,this.vertSize=6,this.stride=4*this.vertSize,this.batchSize=2e3,this.batchSprites=[],this.contextLost=!1,this.vertices=new Float32Array(4*this.batchSize*this.vertSize),this.indices=new Uint16Array(6*this.batchSize),this.lastIndexCount=0,this.drawing=!1,this.currentBatchSize=0,this.currentBaseTexture=null,this.dirty=!0,this.textures=[],this._UID=0,this.boot()},b.Game.prototype={boot:function(){if(!this.isBooted){var a=this.boot.bind(this);"complete"===document.readyState||"interactive"===document.readyState?document.body?(document.removeEventListener("deviceready",a),document.removeEventListener("DOMContentLoaded",a),window.removeEventListener("load",a),this.isBooted=!0,this.init()):window.setTimeout(a,20):(document.addEventListener("DOMContentLoaded",a,!1),window.addEventListener("load",a,!1))}},init:function(){this.cache=new b.Cache(this),this.load=new b.Loader(this),this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.contextLostBound=this.handleContextLost.bind(this),this.contextRestoredBound=this.handleContextRestored.bind(this),this.canvas.addEventListener("webglcontextlost",this.contextLostBound,!1),this.canvas.addEventListener("webglcontextrestored",this.contextRestoredBound,!1),this.initWebGL(),this.addToDOM(),this.state.preload?(this.state.preload.call(this.state,this),0===this.load._totalFileCount?this.start():this.load.start()):this.start()},start:function(){this.state.create&&this.state.create.call(this.state,this),window.requestAnimationFrame(this.update.bind(this))},update:function(){this.state.update&&this.state.update.call(this.state,this),this.renderWebGL(),window.requestAnimationFrame(this.update.bind(this))},addToDOM:function(){var a;this.parent&&("string"==typeof this.parent?a=document.getElementById(this.parent):"object"==typeof this.parent&&1===this.parent.nodeType&&(a=this.parent)),a||(a=document.body),a.appendChild(this.canvas)},initCanvas:function(){this.context=this.canvas.getContext("2d",{alpha:!1})},renderCanvas:function(){this.context.clearRect(0,0,this.width,this.height),this.renderDisplayObject(this.root,this.projection)},handleContextLost:function(a){a.preventDefault(),this.contextLost=!0},handleContextRestored:function(){this.initWebGL(),this.contextLost=!1},initWebGL:function(){var a=this.canvas.getContext("webgl",this.contextOptions)||this.canvas.getContext("experimental-webgl",this.contextOptions);if(this.gl=a,!a)throw new Error("Browser does not support WebGL");this.glContextId=a.id=0,b.log("initWebGL "+this.glContextId),a.disable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.enable(a.BLEND),this.gl.viewport(0,0,this.width,this.height),this.projection.x=this.width/2,this.projection.y=-this.height/2;for(var c=0,d=0;c<6*this.batchSize;c+=6,d+=4)this.indices[c+0]=d+0,this.indices[c+1]=d+1,this.indices[c+2]=d+2,this.indices[c+3]=d+0,this.indices[c+4]=d+2,this.indices[c+5]=d+3;this.vertexBuffer=a.createBuffer(),this.indexBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.indices,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,this.vertices,a.DYNAMIC_DRAW),this.currentBlendMode=99999,this.initShader()},initShader:function(){b.log("initShader","#ffffff","#ff0000");var a=this.gl,c=["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform vec2 projectionVector;","uniform vec2 offsetVector;","varying vec2 vTextureCoord;","varying vec4 vColor;","const vec2 center = vec2(-1.0, 1.0);","void main(void) {","   gl_Position = vec4( ((aVertexPosition + offsetVector) / projectionVector) + center , 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vec3 color = mod(vec3(aColor.y / 65536.0, aColor.y / 256.0, aColor.y), 256.0) / 256.0;","   vColor = vec4(color * aColor.x, aColor.x);","}"],d=["precision lowp float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void) {","   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;","}"],e=this.compileShader(d,a.FRAGMENT_SHADER),f=this.compileShader(c,a.VERTEX_SHADER),g=a.createProgram();return a.attachShader(g,f),a.attachShader(g,e),a.linkProgram(g),a.getProgramParameter(g,a.LINK_STATUS)?(a.useProgram(g),a.enableVertexAttribArray(0),a.enableVertexAttribArray(1),a.enableVertexAttribArray(2),this.uSampler=a.getUniformLocation(g,"uSampler"),this.projectionVector=a.getUniformLocation(g,"projectionVector"),this.offsetVector=a.getUniformLocation(g,"offsetVector"),this.dimensions=a.getUniformLocation(g,"dimensions"),this.program=g,!0):(b.log("Could not initialise shaders"),!1)},compileShader:function(a,b){var c=this.gl,a=a.join("\n"),d=c.createShader(b);return c.shaderSource(d,a),c.compileShader(d),c.getShaderParameter(d,c.COMPILE_STATUS)?d:null},renderWebGL:function(){if(!this.contextLost){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),a.clearColor(.5,0,0,1),a.clear(a.COLOR_BUFFER_BIT),this.drawCount=0,this.currentBatchSize=0,this.batchSprites=[],this.dirty=!0;for(var b=0;b<this.children.length;b++)this.children[b].updateTransform(),this.renderSprite(this.children[b]);this.flushBatch()}},renderSprite:function(a){var b=a.texture;this.currentBatchSize>=this.batchSize&&(this.flushBatch(),this.currentBaseTexture=b.baseTexture);var c=b._uvs,d=1,e=16777215,f=this.vertices,g=0,h=0,i=b.frame.width*(1-g),j=b.frame.width*-g,k=b.frame.height*(1-h),l=b.frame.height*-h,m=4*this.currentBatchSize*this.vertSize,n=1,o=a.worldTransform,p=o.a/n,q=o.b/n,r=o.c/n,s=o.d/n,t=o.tx,u=o.ty;f[m++]=p*j+r*l+t,f[m++]=s*l+q*j+u,f[m++]=c.x0,f[m++]=c.y0,f[m++]=d,f[m++]=e,f[m++]=p*i+r*l+t,f[m++]=s*l+q*i+u,f[m++]=c.x1,f[m++]=c.y1,f[m++]=d,f[m++]=e,f[m++]=p*i+r*k+t,f[m++]=s*k+q*i+u,f[m++]=c.x2,f[m++]=c.y2,f[m++]=d,f[m++]=e,f[m++]=p*j+r*k+t,f[m++]=s*k+q*j+u,f[m++]=c.x3,f[m++]=c.y3,f[m++]=d,f[m++]=e,this.batchSprites[this.currentBatchSize++]=a},flushBatch:function(){if(0!==this.currentBatchSize){var a=this.gl;if(this.dirty&&(this.dirty=!1,a.activeTexture(a.TEXTURE0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a.uniform2f(this.projectionVector,this.projection.x,this.projection.y),a.vertexAttribPointer(0,2,a.FLOAT,!1,this.stride,0),a.vertexAttribPointer(1,2,a.FLOAT,!1,this.stride,8),a.vertexAttribPointer(2,2,a.FLOAT,!1,this.stride,16)),this.currentBatchSize>.5*this.batchSize)a.bufferSubData(a.ARRAY_BUFFER,0,this.vertices);else{var b=this.vertices.subarray(0,4*this.currentBatchSize*this.vertSize);a.bufferSubData(a.ARRAY_BUFFER,0,b)}for(var c,d=null,e=0,f=0,g=null,h=0,i=this.currentBatchSize;i>h;h++)c=this.batchSprites[h],d=c.texture.baseTexture,g!==d&&(e>0&&(a.bindTexture(a.TEXTURE_2D,g._glTextures[a.id]),a.drawElements(a.TRIANGLES,6*e,a.UNSIGNED_SHORT,6*f*2),this.drawCount++),f=h,e=0,g=d),e++;e>0&&(a.bindTexture(a.TEXTURE_2D,g._glTextures[a.id]),a.drawElements(a.TRIANGLES,6*e,a.UNSIGNED_SHORT,6*f*2),this.drawCount++),this.currentBatchSize=0}},updateTexture:function(a){b.log("updateTexture: "+a),console.log("al",a.premultipliedAlpha),console.log("pot",a._powerOf2);var c=this.gl;return a._glTextures[c.id]||(a._glTextures[c.id]=c.createTexture(),b.log("updateTexture new id: "+c.id)),c.bindTexture(c.TEXTURE_2D,a._glTextures[c.id]),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultipliedAlpha),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a.source),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),a._powerOf2?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)),a._dirty[c.id]=!1,a._glTextures[c.id]},addChild:function(a,c,d){var e=new b.Sprite(this,a,c,d);return e.parent=this,this.children.push(e),e}},b.Cache=function(a){this.game=a,this._cache={image:{}}},b.Cache.prototype={addImage:function(a,c,d){var e={key:a,url:c,data:d,base:new b.BaseTexture(d)};return this.game.updateTexture(e.base),this._cache.image[a]=e,e},getBaseTexture:function(a){return this._cache.image[a].base},getImage:function(a,b){var c=this._cache.image[a];return b?c:c.data}},b.Loader=function(a){this.game=a,this.cache=a.cache,this.baseURL="",this.path="",this.isLoading=!1,this.hasLoaded=!1,this._fileList=[],this._flightQueue=[],this._fileLoadStarted=!1,this._totalFileCount=0},b.Loader.prototype={reset:function(){this.isLoading=!1,this.hasLoaded=!1,this._fileList.length=0,this._flightQueue.length=0,this._fileLoadStarted=!1,this._totalFileCount=0,this._processingHead=0},addToFileList:function(a,b,c,d,e){if(void 0===b||""===b)return console.warn("Phaser.Loader: Invalid or no key given of type "+a),this;if(void 0===c||null===c){if(!e)return console.warn("Phaser.Loader: No URL given for file type: "+a+" key: "+b),this;c=b+e}var f={type:a,key:b,path:this.path,url:c,data:null,loading:!1,loaded:!1,error:!1};if(d)for(var g in d)f[g]=d[g];return this._fileList.push(f),this._totalFileCount++,this},image:function(a,b){return this.addToFileList("image",a,b,void 0,".png")},start:function(){this.isLoading||(this.hasLoaded=!1,this.isLoading=!0,this._processingHead=0,this.processLoadQueue())},processLoadQueue:function(){if(!this.isLoading)return console.warn("Phaser.Loader - active loading canceled / reset"),void this.finishedLoading(!0);for(var a=0;a<this._flightQueue.length;a++){var c=this._flightQueue[a];(c.loaded||c.error)&&(this._flightQueue.splice(a,1),a--,c.loading=!1,c.requestUrl=null,c.requestObject=null,c.error&&b.log("File loading error"+c.key),this._loadedFileCount++,b.log("File Complete "+c.key))}for(var a=this._processingHead;a<this._fileList.length;a++){var c=this._fileList[a];if(c.loaded||c.error?a===this._processingHead&&(this._processingHead=a+1):!c.loading&&this._flightQueue.length<4&&(this._fileLoadStarted||(this._fileLoadStarted=!0),this._flightQueue.push(c),c.loading=!0,this.loadFile(c)),this._flightQueue.length>=4)break}if(this._processingHead>=this._fileList.length)this.finishedLoading();else if(!this._flightQueue.length){console.warn("Phaser.Loader - aborting: processing queue empty, loading may have stalled");var d=this;setTimeout(function(){d.finishedLoading(!0)},2e3)}},loadFile:function(a){switch(a.type){case"image":this.loadImageTag(a)}},loadImageTag:function(a){var b=this;a.data=new Image,a.data.name=a.key,this.crossOrigin&&(a.data.crossOrigin=this.crossOrigin),a.data.onload=function(){a.data.onload&&(a.data.onload=null,a.data.onerror=null,b.fileComplete(a))},a.data.src=this.transformUrl(a.url,a),a.data.complete&&a.data.width&&a.data.height&&(a.data.onload=null,a.data.onerror=null,this.fileComplete(a))},transformUrl:function(a,b){return a?a.match(/^(?:blob:|data:|http:\/\/|https:\/\/|\/\/)/)?a:this.baseURL+b.path+a:!1},fileComplete:function(a,b){var c=!0;switch(a.type){case"image":this.cache.addImage(a.key,a.url,a.data)}c&&this.asyncComplete(a)},asyncComplete:function(a,b){void 0===b&&(b=""),a.loaded=!0,a.error=!!b,b&&(a.errorMessage=b,console.warn("Phaser.Loader - "+a.type+"["+a.key+"]: "+b)),this.processLoadQueue()},finishedLoading:function(a){this.hasLoaded||(this.hasLoaded=!0,this.isLoading=!1,a||this._fileLoadStarted||(this._fileLoadStarted=!0),this.reset(),b.log("Load Complete"),this.game.start())}},b.Sprite=function(a,c,d,e){this.game=a,this.position={x:c,y:d},this.scale={x:1,y:1},this.anchor={x:0,y:0},this.pivot={x:0,y:0},this.rotation=0,this.visible=!0,this.renderable=!0,this.parent=null,this.worldAlpha=1,this.alpha=1,this.worldTransform=new b.Matrix,this.tint=16777215;var f=a.cache.getBaseTexture(e);this.texture=new b.Texture(f),this._width=f.width,this._height=f.height},b.Sprite.prototype={updateTransform:function(){var a,b,c,d,e=this.parent.worldTransform,f=this.worldTransform;a=this.scale.x,b=this.scale.y,c=this.position.x-this.pivot.x*a,d=this.position.y-this.pivot.y*b,f.a=a*e.a,f.b=a*e.b,f.c=b*e.c,f.d=b*e.d,f.tx=c*e.a+d*e.c+e.tx,f.ty=c*e.b+d*e.d+e.ty,this.worldAlpha=this.alpha*this.parent.worldAlpha}},b.Sprite.prototype.constructor=b.Sprite,Object.defineProperties(b.Sprite.prototype,{width:{get:function(){return this.scale.x*this.texture.frame.width},set:function(a){this.scale.x=a/this.texture.frame.width,this._width=a}},height:{get:function(){return this.scale.y*this.texture.frame.height},set:function(a){this.scale.y=a/this.texture.frame.height,this._height=a}},worldVisible:{get:function(){var a=this;do{if(!a.visible)return!1;a=a.parent}while(a);return!0}},x:{get:function(){return this.position.x},set:function(a){this.position.x=a}},y:{get:function(){return this.position.y},set:function(a){this.position.y=a}}}),b.Texture=function(a){this.baseTexture=a,this.frame={x:0,y:0,width:a.width,height:a.height},this.width=this.frame.width,this.height=this.frame.height,this.requiresUpdate=!1,this._uvs={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,x3:0,y3:0},this._updateUvs()},b.Texture.prototype={_updateUvs:function(){var a=this.frame,b=this.baseTexture.width,c=this.baseTexture.height;this._uvs.x0=a.x/b,this._uvs.y0=a.y/c,this._uvs.x1=(a.x+a.width)/b,this._uvs.y1=a.y/c,this._uvs.x2=(a.x+a.width)/b,this._uvs.y2=(a.y+a.height)/c,this._uvs.x3=a.x/b,this._uvs.y3=(a.y+a.height)/c}},b.BaseTexture=function(a){this.width=a.width,this.height=a.height,this.source=a,this.premultipliedAlpha=!0,this._glTextures=[],this._dirty=[!0,!0,!0,!0],this._powerOf2=!1},b.BaseTexture.prototype={dirty:function(){for(var a=0;a<this._glTextures.length;a++)this._dirty[a]=!0},unloadFromGPU:function(){for(var a=this._glTextures.length-1;a>=0;a--){var b=this._glTextures[a];this.gl&&b&&this.gl.deleteTexture(b)}this._glTextures.length=0,this.dirty()}},b.Matrix=function(){this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0},b.Matrix.prototype={fromArray:function(a){this.a=a[0],this.b=a[1],this.c=a[3],this.d=a[4],this.tx=a[2],this.ty=a[5]},toArray:function(a){this.array||(this.array=new Float32Array(9));var b=this.array;return a?(b[0]=this.a,b[1]=this.b,b[2]=0,b[3]=this.c,b[4]=this.d,b[5]=0,b[6]=this.tx,b[7]=this.ty,b[8]=1):(b[0]=this.a,b[1]=this.c,b[2]=this.tx,b[3]=this.b,b[4]=this.d,b[5]=this.ty,b[6]=0,b[7]=0,b[8]=1),b},apply:function(a,b){return b=b||{x:0,y:0},b.x=this.a*a.x+this.c*a.y+this.tx,b.y=this.b*a.x+this.d*a.y+this.ty,b},applyInverse:function(a,b){b=b||new{x:0,y:0};var c=1/(this.a*this.d+this.c*-this.b);return b.x=this.d*c*a.x+-this.c*c*a.y+(this.ty*this.c-this.tx*this.d)*c,b.y=this.a*c*a.y+-this.b*c*a.x+(-this.ty*this.a+this.tx*this.b)*c,b},translate:function(a,b){return this.tx+=a,this.ty+=b,this},scale:function(a,b){return this.a*=a,this.d*=b,this.c*=a,this.b*=b,this.tx*=a,this.ty*=b,this},rotate:function(a){var b=Math.cos(a),c=Math.sin(a),d=this.a,e=this.c,f=this.tx;return this.a=d*b-this.b*c,this.b=d*c+this.b*b,this.c=e*b-this.d*c,this.d=e*c+this.d*b,this.tx=f*b-this.ty*c,this.ty=f*c+this.ty*b,this},append:function(a){var b=this.a,c=this.b,d=this.c,e=this.d;return this.a=a.a*b+a.b*d,this.b=a.a*c+a.b*e,this.c=a.c*b+a.d*d,this.d=a.c*c+a.d*e,this.tx=a.tx*b+a.ty*d+this.tx,this.ty=a.tx*c+a.ty*e+this.ty,this},identity:function(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}},b.identityMatrix=new b.Matrix,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports.PhaserMicro=b):"undefined"!=typeof define&&define.amd?define("PhaserMicro",function(){return a.PhaserMicro=b}()):a.PhaserMicro=b,b}).call(this);